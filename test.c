// Algorithm by Drake Rochelle
#include <math.h>
#include <stdio.h>
#include <time.h>
#define PI 3.14159265358979323
#define TWO_PI (2 * PI)
#define DT 0.05
#define VALUES_COUNT 127
double values[VALUES_COUNT] = {0.0,
                               0.04997916927067833,
                               0.09983341664682815,
                               0.14943813247359924,
                               0.19866933079506122,
                               0.24740395925452294,
                               0.2955202066613396,
                               0.3428978074554514,
                               0.3894183423086505,
                               0.43496553411123023,
                               0.479425538604203,
                               0.5226872289306592,
                               0.5646424733950355,
                               0.6051864057360395,
                               0.6442176872376911,
                               0.6816387600233341,
                               0.7173560908995228,
                               0.7512804051402927,
                               0.7833269096274834,
                               0.8134155047893737,
                               0.8414709848078965,
                               0.867423225594017,
                               0.8912073600614354,
                               0.9127639402605211,
                               0.9320390859672264,
                               0.9489846193555862,
                               0.963558185417193,
                               0.9757233578266591,
                               0.9854497299884603,
                               0.9927129910375885,
                               0.9974949866040544,
                               0.999783764189357,
                               0.9995736030415051,
                               0.9968650284539189,
                               0.9916648104524686,
                               0.9839859468739369,
                               0.9738476308781951,
                               0.9612752029752999,
                               0.9463000876874145,
                               0.9289597150038692,
                               0.9092974268256817,
                               0.8873623686333753,
                               0.8632093666488737,
                               0.8368987907984977,
                               0.8084964038195901,
                               0.7780731968879212,
                               0.74570521217672,
                               0.7114733527908443,
                               0.6754631805511506,
                               0.6377647021345036,
                               0.5984721441039564,
                               0.5576837173914166,
                               0.5155013718214642,
                               0.47203054128988226,
                               0.4273798802338298,
                               0.3816609920523317,
                               0.33498815015590466,
                               0.2874780123425444,
                               0.23924932921398198,
                               0.19042264736102704,
                               0.1411200080598672,
                               0.09146464223243675,
                               0.04158066243329049,
                               -0.008407247367149063,
                               -0.058374143427580086,
                               -0.10819513453010837,
                               -0.15774569414324865,
                               -0.20690197167339974,
                               -0.25554110202683167,
                               -0.30354151270842933,
                               -0.35078322768961984,
                               -0.3971481672859602,
                               -0.44252044329485246,
                               -0.48678664865569976,
                               -0.5298361409084934,
                               -0.5715613187423437,
                               -0.6118578909427193,
                               -0.6506251370651673,
                               -0.6877661591839741,
                               -0.7231881240865121,
                               -0.7568024953079282,
                               -0.788525254426195,
                               -0.8182771110644108,
                               -0.8459837010754465,
                               -0.8715757724135882,
                               -0.8949893582285835,
                               -0.9161659367494549,
                               -0.9350525775584494,
                               -0.9516020738895161,
                               -0.9657730606206388,
                               -0.977530117665097,
                               -0.9868438585032365,
                               -0.9936910036334645,
                               -0.9980544387588794,
                               -0.9999232575641008,
                               -0.999292788975378,
                               -0.9961646088358406,
                               -0.9905465359667132,
                               -0.9824526126243325,
                               -0.9719030694018208,
                               -0.9589242746631385,
                               -0.9435486686359064,
                               -0.9258146823277321,
                               -0.9057666414687044,
                               -0.8834546557201531,
                               -0.858934493426592,
                               -0.8322674422239008,
                               -0.8035201558521553,
                               -0.7727644875559871,
                               -0.7400773104888944,
                               -0.7055403255703919,
                               -0.6692398572762613,
                               -0.6312666378723208,
                               -0.5917155806310094,
                               -0.5506855425976376,
                               -0.5082790774992583,
                               -0.4646021794137566,
                               -0.4197640178398589,
                               -0.373876664830236,
                               -0.32705481486974064,
                               -0.27941549819892586,
                               -0.23107778829939138,
                               -0.18216250427209502,
                               -0.13279190885251674,
                               -0.0830894028174964,
                               -0.03317921654755682,
                               0.0168139004843506};
double sin_proprietary_fast(double x) {
  double INV_TWO_PI = 1.0 / TWO_PI;
  double R = 1.0 / DT;
  x = x - TWO_PI * (int)(x * INV_TWO_PI);
  double scaled = x * R;
  int index = (int)scaled;
  double t = scaled - index;
  return (values[index] + t * (values[index + 1] - values[index])) * 1.00016252;
}

double sin_taylor(double a) {
  double pi2 = PI / 2;
  double x = fmod((a + pi2), (PI * 2)) - pi2;

  double x2 = x * x;     // x²
  double x3 = x * x2;    // x³
  double x5 = x3 * x2;   // x⁵
  double x7 = x5 * x2;   // x⁷
  double x9 = x7 * x2;   // x⁹
  double x11 = x9 * x2;  // x¹¹
  double x13 = x11 * x2; // x¹³

  return x - (x3 / 6.0) + (x5 / 120.0) - (x7 / 5040.0) + (x9 / 362880.0) -
         (x11 / 39916800.0) + (x13 / 6227020800.0);
}

int main() {
  printf("%u\n", VALUES_COUNT * sizeof(values[0]));
  clock_t start, end;
  double elapsed;
  volatile double d = 0.0;
  start = clock();
  for (int i = 0; i < 1000000; ++i) {
    d += sin_proprietary_fast((i * TWO_PI) / 1000000);
  }
  end = clock();
  elapsed = ((double)(end - start)) / CLOCKS_PER_SEC;
  printf("Time (proprietary): %f seconds\n", elapsed);
  d = 0.0;
  start = clock();
  for (int i = 0; i < 1000000; ++i) {
    d += sin((i * TWO_PI) / 1000000);
  }
  end = clock();
  elapsed = ((double)(end - start)) / CLOCKS_PER_SEC;
  printf("Time (std): %f seconds\n", elapsed);
  d = 0.0;
  start = clock();
  for (int i = 0; i < 1000000; ++i) {
    d += sin_taylor((i * TWO_PI) / 1000000);
  }
  end = clock();
  elapsed = ((double)(end - start)) / CLOCKS_PER_SEC;
  printf("Time (taylor): %f seconds\n", elapsed);
  double max_error = 0.0;
  for (int i = 0; i < 1000000; ++i) {
    double x = i * TWO_PI / 1000000.0;
    printf("%f\n", sin(x));
    double error = fabs(sin_proprietary_fast(x) - sin(x));
    if (error > max_error) {
      max_error = error;
    }
  }
  printf("Max error (proprietary): %f\n", max_error);
  if (d == -999999.999999) {
    printf("This prevents optimization: %f\n", d);
  }
  return 0;
}
